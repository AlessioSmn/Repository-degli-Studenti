<!DOCTYPE html>
<html lang="it">
<head>
	<meta charset="utf-8">
      <title>Repository studenti</title>
      <link rel="stylesheet" type="text/CSS" href="css/themes/light.css" id="theme">
      <link rel="stylesheet" type="text/CSS" href="css/general.css">
      <link rel="stylesheet" type="text/CSS" href="css/header.css">
      <link rel="stylesheet" type="text/CSS" href="css/navbar.css">
      <link rel="stylesheet" type="text/CSS" href="css/footer.css">
      <link rel="stylesheet" type="text/CSS" href="css/form.css">
      <link rel="stylesheet" type="text/CSS" href="css/custom.css">
      <link rel="icon" type="image/ICO" href="media/.ico/cherubino_pant541.ico">
      <script src="js/theme/themeControl.js"></script>
      <script src="js/logControl/logout.js"></script>
</head>
<body onload="setCurrentCustomTheme();">
      <header>
            <h1>Tema personalizzato</h1>
      </header>

      <!-- Barra di navigazione del sito -->
      <nav id="navbar">
            <div class="side-navbar-visualizer" onclick="sideNavbarToggle()">Menu</div>
            <a href="index.php" class="navbar-main-element"><div><span>Home</span></div></a>
            <div class="navbar-main-element navbar-dropdown-main">
                  <span>Accesso</span>
                  <div class="navbar-dropdown-container">
                        <a class="navbar-dropdown-option" href="login.php">Login</a>
                        <a class="navbar-dropdown-option" href="signup.php">Registrati</a>
                        <a class="navbar-dropdown-option" onclick="logout()">Logout</a>
                  </div>
            </div>
            <div class="navbar-main-element navbar-dropdown-main">
                  <span>Area personale</span>
                  <div class="navbar-dropdown-container">
                        <a href="personal.php" class="navbar-dropdown-option">Documenti</a>
                        <a href="uploaddocument.php" class="navbar-dropdown-option">Upload</a>
                        <a href="#" class="navbar-dropdown-option current-page">Tema custom</a>
                  </div>
            </div>
            <a href="search.php" class="navbar-main-element"><div><span>Cerca</span></div></a>
            <a href="statistics.php" class="navbar-main-element"><div><span>Statistiche</span></div></a>
            <a href="manual.html" class="navbar-main-element"><div><span>Manuale</span></div></a>
            <div class="navbar-main-element floating" onclick="logout()"><span>Logout</span></div>
            <div class="navbar-main-element navbar-dropdown-main floating">
                  <span>Tema</span>
                  <div class="navbar-dropdown-container">
                        <a class="navbar-dropdown-option" onclick="setTheme('dark')">Scuro</a>
                        <a class="navbar-dropdown-option" onclick="setTheme('grey')">Grigio</a>
                        <a class="navbar-dropdown-option" onclick="setTheme('light')">Chiaro</a>
                        <a class="navbar-dropdown-option" onclick="setTheme('pantone')">Pantone</a>
                        <a class="navbar-dropdown-option" onclick="setTheme(CUSTOM_THEME)">Custom</a>
                  </div>
            </div>
      </nav>

      <div class="form-grid" style="margin:50px 0px;">
            <div class="form-grid-data-row">

                  <div style="padding: 20px; text-align: justify;">
                        <h3>Crea il tuo tema personalizzato</h3>
                        <p>
                              In questa pagina puoi creare un tema a tuo piacimento da utilizzare per la navigazione nel sito.
                              Puoi scegliere colore per colore oppure impostare solo i colori pincipale e regolare le versioni 
                              chiara e scura utilizzando lo slider. Se vuoi impostare solo una delle due versioni del colore puoi
                              bloccarla e andare a regolare con lo slider solo la versione non bloccata.
                        </p>
                  
                        <button onclick="saveTheme(event)">Salva e utilizza tema</button>
                  </div>
                  <form id="themeForm">
                        <table>
                              <tr>
                                    <th></th>
                                    <th>Blocca</th>
                                    <th>Versione chiara</th>
                                    <th>Colore</th>
                                    <th>Versione scura</th>
                                    <th>Blocca</th>
                                    <th>Slider</th>
                              </tr>
                              <tr>
                                    <td><label>Colore dello sfondo</label></td>
                                    <td><input type="checkbox"></td>
                                    <td><input type="color" value="#e0ffff" name="bgColor_light"></td>
                                    <td><input type="color" value="#b7efef" name="bgColor" onchange="updateColor(this)"></td>
                                    <td><input type="color" value="#90dfdf" name="bgColor_dark"></td>
                                    <td><input type="checkbox"></td>
                                    <td><input type="range" value="50" min="-100" max="100" oninput="updateColor(this)"></td>
                              </tr>
                              <tr>
                                    <td><label>Colore del testo</label></td>
                                    <td><input type="checkbox"></td>
                                    <td><input type="color" value="#500050" name="foreColor_light"></td>
                                    <td><input type="color" value="#200020" name="foreColor" onchange="updateColor(this)"></td>
                                    <td><input type="color" value="#000000" name="foreColor_dark"></td>
                                    <td><input type="checkbox"></td>
                                    <td><input type="range" value="50" min="-100" max="100" oninput="updateColor(this)"></td>
                              </tr>
                              <tr>
                                    <td><label>Colore primario</label></td>
                                    <td><input type="checkbox"></td>
                                    <td><input type="color" value="#fff080" name="primary_light"></td>
                                    <td><input type="color" value="#ffe030" name="primary" onchange="updateColor(this)"></td>
                                    <td><input type="color" value="#f0b020" name="primary_dark"></td>
                                    <td><input type="checkbox"></td>
                                    <td><input type="range" value="50" min="-100" max="100" oninput="updateColor(this)"></td>
                              </tr>
                              <tr>
                                    <td><label>Colore secondario</label></td>
                                    <td><input type="checkbox"></td>
                                    <td><input type="color" value="#ff70fe" name="secondary_light"></td>
                                    <td><input type="color" value="#f040f0" name="secondary" onchange="updateColor(this)"></td>
                                    <td><input type="color" value="#e020d8" name="secondary_dark"></td>
                                    <td><input type="checkbox"></td>
                                    <td><input type="range" value="50" min="-100" max="100" oninput="updateColor(this)"></td>
                              </tr>
                        </table>
                  </form>
            </div>
      </div>

      <footer>
            <div class="left-section">
                  <span>Autore</span> <span>Alessio Simoncini</span><br>
                  <span>Materia</span> <span>Progettazione WEB</span><br>
                  <span>Codice</span> <span>080II</span>
                  <hr>
                  <span>Corso di studio</span> <span>CdS Ingegneria Informatica</span><br>
                  <span>Dipartimento</span> <span>Dipartimento di Ingegneria dell'informazione</span><br>
                  <span>Scuola</span> <span>Scuola di Ingegneria</span><br>
                  <span>Universit&agrave;</span> <span>Universit&agrave; di Pisa</span><br>
                  <span>Indirizzo</span> <address>Lungarno Pacinotti 43, 56126 Pisa</address>
            </div>
            <div class="right-section">
                  <img alt="logo della società" class="company-logo" id="footerUnipiLogo" src="media/.ico/cherubino_black.ico">
            </div>
      </footer>
      
      <script src="js/navbar/navbarresizing.js"></script>
      
      <script>
            /**
             * Salva il tema impostato mediante i vari input in cache e lo imposta come tema corrente
             */ 
            function saveTheme(event){
                  event.preventDefault();

                  const inputTable = document.getElementById('themeForm');

                  // Salvo in cache un array contenente le varibili CSS per i vari colori
                  const customTheme = {
                        '--bgColor_light': inputTable.elements['bgColor_light'].value,
                        '--bgColor': inputTable.elements['bgColor'].value,
                        '--bgColor_dark': inputTable.elements['bgColor_dark'].value,

                        '--foreColor_light': inputTable.elements['foreColor_light'].value,
                        '--foreColor': inputTable.elements['foreColor'].value,
                        '--foreColor_dark': inputTable.elements['foreColor_dark'].value,

                        '--primary_light': inputTable.elements['primary_light'].value,
                        '--primary': inputTable.elements['primary'].value,
                        '--primary_dark': inputTable.elements['primary_dark'].value,

                        '--secondary_light': inputTable.elements['secondary_light'].value,
                        '--secondary': inputTable.elements['secondary'].value,
                        '--secondary_dark': inputTable.elements['secondary_dark'].value,
                  };

                  // Salvo l'array serializzato in cache 
                  localStorage.setItem('customThemeInfo', JSON.stringify(customTheme));

                  // Utilizzo il tema
                  setTheme(CUSTOM_THEME)
            }

            /**
             * Imposta i valori degli input dei colori al valore impostato, se presente
             */
            function setCurrentCustomTheme() {
                  // Controllo che sia stato definito un tema custom
                  const storedCustomTheme = localStorage.getItem('customThemeInfo');

                  // in tal caso scorro tutte le regole
                  if (storedCustomTheme) {

                        // Deserializzo il tema in un array di variabili css
                        const customTheme = JSON.parse(storedCustomTheme);

                        // Scorro sui vari campi (le varie varibili --bgColor, --foreColor, etc)
                        for(let themeElement in customTheme){

                              // cerco l'elemento input con il nome corrispondente (tolgo però il '--' quando cerco il nome)
                              let inputName = themeElement.substring(2, themeElement.length);
                              const input = document.querySelector('[name="' + inputName + '"]');

                              // imposto il value corrente con il colore della variabile, il suo valore
                              if (input) input.value = customTheme[themeElement];
                        }
                  }
            }

            const lightLockIndex = 1;
            const lighterColorIndex = 2;
            const baseColorIndex = 3;
            const darkerColorIndex = 4;
            const darkLockIndex = 5;
            const sliderIndex = 6;

            /**
             * @param {HTMLElement} CallerElement
             */
            function updateColor(CallerElement){
                  // Accedo ai 'fratelli' dell'elemento chiamante
                  let tableRow = CallerElement.parentNode.parentNode;
                  let tableCells = Array.from(tableRow.children);

                  // Riferimento ai singoli fratelli, per comodità
                  let baseColor = Array.from(tableCells[baseColorIndex].children)[0];
                  let shadeSlider = Array.from(tableCells[sliderIndex].children)[0];     
                  // Colore base impostato e percentuale di scostamento da questo      
                  let newBaseColor = baseColor.value;
                  let percentage = shadeSlider.value;    

                  // Controllo se il colore chiaro può variare con il colore base
                  let lightColorLock = Array.from(tableCells[lightLockIndex].children)[0];
                  if(!lightColorLock.checked){
                        let lighterColor = Array.from(tableCells[lighterColorIndex].children)[0];  
                        lighterColor.value = shadeColor(newBaseColor, +percentage);
                  }

                  // Controllo se il colore chiaro può variare con il colore base
                  let darkColorLock = Array.from(tableCells[darkLockIndex].children)[0];
                  if(!darkColorLock.checked){
                        let darkerColor = Array.from(tableCells[darkerColorIndex].children)[0];
                        darkerColor.value = shadeColor(newBaseColor, -percentage);
                  }
            }

            function shadeColor(color, percent) {

                  let finalColor = '#';

                  // Ciclo su R, G e B
                  for(let index = 1; index < 7; index += 2){

                        // Prendo le due cifre esadecimali
                        let colorComponent = parseInt(color.substring(index, index + 2), 16);

                        // Scalo la componente
                        let shadedComponent = colorComponent * (100 + percent) / 100;

                        // Controllo che sia minore o uguale a 255
                        shadedComponent = Math.min(shadedComponent, 255);

                        // Arrotondo ad intero
                        shadedComponent = Math.round(shadedComponent);

                        // Converto in esadecimale, eventualmente mettendo uno 0 per rimanere su due cifre
                        let hexaComponent = '';
                        if(shadedComponent < 16) hexaComponent += '0';
                        hexaComponent += shadedComponent.toString(16);

                        finalColor += hexaComponent;
                  }

                  return finalColor;
            }
      </script>
</body>
</html>